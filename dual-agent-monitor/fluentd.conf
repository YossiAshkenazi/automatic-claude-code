# Fluentd configuration for dual-agent monitoring logs

<source>
  @type tail
  path /var/log/app/*.log
  pos_file /var/log/fluentd/app.log.pos
  tag dual-agent.app
  format json
  time_key timestamp
  time_format %Y-%m-%dT%H:%M:%S.%L%z
  refresh_interval 10s
</source>

<source>
  @type tail
  path /var/log/nginx/access.log
  pos_file /var/log/fluentd/nginx-access.log.pos
  tag dual-agent.nginx.access
  format nginx
  refresh_interval 10s
</source>

<source>
  @type tail
  path /var/log/nginx/error.log
  pos_file /var/log/fluentd/nginx-error.log.pos
  tag dual-agent.nginx.error
  format /^(?<timestamp>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[(?<log_level>\w+)\] (?<pid>\d+)#(?<tid>\d+): (?<message>.*)/
  time_key timestamp
  time_format %Y/%m/%d %H:%M:%S
  refresh_interval 10s
</source>

<filter dual-agent.**>
  @type record_transformer
  <record>
    hostname ${hostname}
    service dual-agent-monitor
    environment production
  </record>
</filter>

<match dual-agent.**>
  @type stdout
  @log_level info
</match>

# Optional: Forward to external log aggregation service
# <match dual-agent.**>
#   @type forward
#   <server>
#     name external-log-server
#     host log.example.com
#     port 24224
#   </server>
#   <buffer>
#     @type memory
#     flush_interval 10s
#     flush_thread_count 2
#   </buffer>
# </match>